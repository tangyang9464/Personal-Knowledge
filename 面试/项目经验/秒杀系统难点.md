#### 秒杀系统

##### 基本流程

- 检查库存（并发读）- 可用redis
- 减去库存并且创建订单（并发写）-可用消息队列异步操作 

##### 难点

###### 超卖

- 不加锁：1，2步通过进行，会造成库存更新的覆盖，导致订单数量远远大于减少的库存
- 乐观锁：对2步更新用乐观锁保证正确，但会导致**失败的请求次数比较多，高并发时无法卖出全部商品**
- 悲观锁：使用Spring事务，但需要给用户一定提示或者限流，避免一直等

###### 接口限流

- **令牌桶算法**： 大小固定的令牌桶可自行以恒定的速率源源不断地产生令牌。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌就会不断地增多，直到把桶填满。后面再产生的令牌就会从桶中溢出。最后桶中可以保存的最大令牌数永远不会超过桶的大小。
- **单用户限制频率**：防止脚本发送大量请求

###### 防脚本刷单

- **秒杀接口隐藏**：通过先获取验证值，再访问接口。防止简单的脚本直接访问下单接口

###### 引入缓存

- redis库存预热：把库存放进redis，在redis中进行扣减库存
- 内存标记：将库存为0的商品用map标记，不再进入redis进行操作

###### 异步下单

- redis扣减库存，然后放入kafka异步下单。

